<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì˜ˆì•½ ì‹ ì²­</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Flatpickr CSS (Datepicker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        .time-slot.reserved { background-color: #fff3cd; color: #664d03; } /* ì˜ˆì•½ì¤‘ */
        .time-slot.completed { background-color: #d1e7dd; color: #0f5132; } /* ì‚¬ìš©ì™„ë£Œ */
        /* Flatpickr ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        .flatpickr-calendar { font-family: 'Pretendard', sans-serif; }
        .input-group-text { background-color: #fff; border-left: 0; cursor: pointer; }
        #reservationDate { border-right: 0; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header-sub :: header-sub}"></div>
<main class="main-content">
    <div class="container">
        <h1 class="mb-4">ì˜ˆì•½ ì‹ ì²­</h1>

        <!-- ë¶€ì†ì‹¤ ìƒì„¸ ì •ë³´ -->
        <div class="card mb-4">
            <div class="card-header" th:text="${room.name}"></div>
            <div class="card-body">
                <p><strong>ìˆ˜ìš©ì¸ì›:</strong> <span th:text="${room.capacity}"></span>ëª…</p>
                <p><strong>ìƒíƒœ:</strong> <span th:text="${room.status.name()}"></span></p>
                <p><strong>ì„¤ëª…:</strong></p>
                <p th:text="${room.description}"></p>
                <hr>
                <p><strong>ì´ë¯¸ì§€:</strong></p>
                <div class="row">
                    <div th:each="image : ${room.images}" class="col-md-4 mb-3">
                        <img th:src="@{${image.path}}" class="img-fluid rounded" alt="Room Image">
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <label for="reservationDate" class="form-label">ë‚ ì§œ ì„ íƒ</label>
                <div class="input-group">
                    <input type="text" class="form-control bg-white" id="reservationDate" th:value="${selectedDate}" readonly>
                    <span class="input-group-text" id="calendar-icon">ğŸ“…</span>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- ì˜ˆì•½ ì‹ ì²­ í¼ -->
            <div class="col-md-5">
                <h5>ì˜ˆì•½í•˜ê¸°</h5>
                <div class="p-3 border rounded">
                    <div class="mb-3">
                        <label for="startTime" class="form-label">ì‹œì‘ ì‹œê°„</label>
                        <select id="startTime" class="form-select">
                            <option th:each="time : ${timeSlots}" th:value="${time}" th:text="${time}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="endTime" class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                        <select id="endTime" class="form-select">
                            <option th:each="time : ${timeSlots}" th:value="${time}" th:text="${time}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reason" class="form-label">ì˜ˆì•½ ì‚¬ìœ </label>
                        <textarea class="form-control" id="reason" rows="3" placeholder="ì˜ˆì•½ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                    <div class="d-grid">
                        <button id="submit-reservation" class="btn btn-primary">ì˜ˆì•½ ì‹ ì²­</button>
                    </div>
                    <p id="past-date-warning" class="text-danger mt-2 text-center" style="display: none;">ê³¼ê±° ë‚ ì§œëŠ” ì˜ˆì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- ì˜ˆì•½ í˜„í™© -->
            <div class="col-md-7">
                <h5>ì˜ˆì•½ í˜„í™©</h5>
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-bordered text-center">
                        <thead>
                            <tr>
                                <th>ì‹œê°„</th>
                                <th>ìƒíƒœ</th>
                                <th>ì˜ˆì•½ì</th>
                                <th>ì‚¬ìœ </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="slot : ${reservationStatus}"
                                th:classappend="${slot.status != null} ? (${slot.status.name() == 'APPROVED'} ? 'time-slot reserved' : (${slot.status.name() == 'COMPLETED'} ? 'time-slot completed' : '')) : ''">
                                <td th:text="${slot.time}"></td>
                                <td th:text="${slot.status == null ? 'ì˜ˆì•½ ê°€ëŠ¥' : (slot.status.name() == 'APPROVED' ? 'ì˜ˆì•½ì¤‘' : (slot.status.name() == 'COMPLETED' ? 'ì‚¬ìš©ì™„ë£Œ' : slot.status.name()))}"></td>
                                <td th:text="${slot.reservedBy}"></td>
                                <td th:text="${slot.reason}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="text-end mt-4">
            <a th:href="@{/reservation/read/{roomId}(roomId=${room.id})}" class="btn btn-secondary">ë’¤ë¡œê°€ê¸°</a>
        </div>
    </div>
</main>
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script> <!-- í•œêµ­ì–´ íŒ¨ì¹˜ -->

<script>
$(document).ready(function() {
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");
    $(document).ajaxSend((e, xhr, options) => xhr.setRequestHeader(header, token));

    // 1. Flatpickr ì´ˆê¸°í™”
    const fp = flatpickr("#reservationDate", {
        locale: "ko", // í•œêµ­ì–´ ì„¤ì •
        dateFormat: "Y-m-d",
        defaultDate: "[[${selectedDate}]]", // ì„œë²„ì—ì„œ ë„˜ì–´ì˜¨ ë‚ ì§œë¡œ ì´ˆê¸°í™”
        onChange: function(selectedDates, dateStr, instance) {
            // ë‚ ì§œ ë³€ê²½ ì‹œ í˜ì´ì§€ ì´ë™ (ì˜ˆì•½ í˜„í™© ê°±ì‹ ì„ ìœ„í•´)
            window.location.href = '/reservation/apply/' + [[${room.id}]] + '?date=' + dateStr;
        }
    });

    // ë‹¬ë ¥ ì•„ì´ì½˜ í´ë¦­ ì‹œ ë‹¬ë ¥ ì—´ê¸°
    $('#calendar-icon').on('click', function() {
        fp.open();
    });

    // 2. ì‹œê°„ í•„í„°ë§ ë° ë²„íŠ¼ ì œì–´ ë¡œì§
    function filterTimeSlots() {
        const selectedDateStr = $('#reservationDate').val();
        const selectedDate = new Date(selectedDateStr);
        const today = new Date();

        // ì‹œê°„ ë¹„êµë¥¼ ìœ„í•´ ë‚ ì§œ ë¶€ë¶„ë§Œ ë‚¨ê¸°ê³  ì‹œê°„ ì´ˆê¸°í™”
        selectedDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);

        const $submitBtn = $('#submit-reservation');
        const $warningMsg = $('#past-date-warning');
        const $timeOptions = $('#startTime option, #endTime option');

        // ì´ˆê¸°í™”: ëª¨ë“  ì˜µì…˜ í‘œì‹œ ë° ë²„íŠ¼ í™œì„±í™”
        $timeOptions.show();
        $submitBtn.prop('disabled', false);
        $submitBtn.text('ì˜ˆì•½ ì‹ ì²­'); // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        $warningMsg.hide();

        if (selectedDate < today) {
            // Case 1: ê³¼ê±° ë‚ ì§œì¸ ê²½ìš°
            $submitBtn.prop('disabled', true);
            $warningMsg.show();
            // ëª¨ë“  ì‹œê°„ ì˜µì…˜ ìˆ¨ê¹€ (ì„ íƒ ë¶ˆê°€)
            $timeOptions.hide();
        } else if (selectedDate.getTime() === today.getTime()) {
            // Case 2: ì˜¤ëŠ˜ ë‚ ì§œì¸ ê²½ìš° -> í˜„ì¬ ì‹œê°„ ì´ì „ì˜ ì˜µì…˜ ìˆ¨ê¹€
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();

            // í˜„ì¬ ì‹œê°„ì„ ë¶„ìœ¼ë¡œ í™˜ì‚°
            const currentTotalMinutes = currentHour * 60 + currentMinute;

            let firstVisibleValue = null;

            $timeOptions.each(function() {
                const timeStr = $(this).val(); // "09:30"
                const [h, m] = timeStr.split(':').map(Number);
                const optionTotalMinutes = h * 60 + m;

                // í˜„ì¬ ì‹œê°„ë³´ë‹¤ ì´ì „ì´ë©´ ìˆ¨ê¹€
                if (optionTotalMinutes <= currentTotalMinutes) {
                    $(this).hide();
                } else {
                    // ìˆ¨ê²¨ì§€ì§€ ì•Šì€ ì²« ë²ˆì§¸ ì˜µì…˜ ì°¾ê¸°
                    if (!firstVisibleValue) {
                        firstVisibleValue = timeStr;
                    }
                }
            });

            // ìˆ¨ê²¨ì§„ ì˜µì…˜ì´ ì„ íƒë˜ì–´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì²« ë²ˆì§¸ ë³´ì´ëŠ” ì˜µì…˜ìœ¼ë¡œ ê°’ ë³€ê²½
            if (firstVisibleValue) {
                $('#startTime').val(firstVisibleValue);
                $('#endTime').val(firstVisibleValue);
            } else {
                // ë§Œì•½ ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ì´ í•˜ë‚˜ë„ ì—†ë‹¤ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
                $submitBtn.prop('disabled', true);
                $submitBtn.text('ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤');
            }
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í•„í„°ë§ ì‹¤í–‰
    filterTimeSlots();

    // 3. ì˜ˆì•½ ì‹ ì²­ ë¡œì§
    $('#submit-reservation').on('click', function() {
        const date = $('#reservationDate').val();
        const startTime = $('#startTime').val();
        const endTime = $('#endTime').val();
        const reason = $('#reason').val(); // ì˜ˆì•½ ì‚¬ìœ  ê°€ì ¸ì˜¤ê¸°

        if (!startTime || !endTime) {
            alert("ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        if (!reason) {
            alert("ì˜ˆì•½ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const reservationData = {
            roomId: [[${room.id}]],
            startTime: date + 'T' + startTime,
            endTime: date + 'T' + endTime,
            reason: reason
        };

        $.ajax({
            url: '/reservation/create',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(reservationData),
            success: function(response) {
                alert(response.message);
                window.location.reload();
            },
            error: function(xhr) {
                alert("ì˜ˆì•½ ì‹¤íŒ¨: " + xhr.responseJSON.message);
            }
        });
    });
});
</script>
</body>
</html>
