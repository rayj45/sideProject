<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>예약 신청</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        .time-slot.reserved { background-color: #f8d7da; color: #58151c; }
        .time-slot.requested { background-color: #fff3cd; color: #664d03; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header-sub :: header-sub}"></div>
<main class="main-content">
    <div class="container">
        <h1 class="mb-4">예약 신청</h1>

        <!-- 부속실 상세 정보 -->
        <div class="card mb-4">
            <div class="card-header" th:text="${room.name}"></div>
            <div class="card-body">
                <p><strong>수용인원:</strong> <span th:text="${room.capacity}"></span>명</p>
                <p><strong>상태:</strong> <span th:text="${room.status.name()}"></span></p>
                <p><strong>설명:</strong></p>
                <p th:text="${room.description}"></p>
                <hr>
                <p><strong>이미지:</strong></p>
                <div class="row">
                    <div th:each="image : ${room.images}" class="col-md-4 mb-3">
                        <img th:src="@{${image.path}}" class="img-fluid rounded" alt="Room Image">
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <label for="reservationDate" class="form-label">날짜 선택</label>
                <input type="date" class="form-control" id="reservationDate" th:value="${selectedDate}">
            </div>
        </div>

        <div class="row">
            <!-- 예약 신청 폼 -->
            <div class="col-md-5">
                <h5>예약하기</h5>
                <div class="p-3 border rounded">
                    <div class="mb-3">
                        <label for="startTime" class="form-label">시작 시간</label>
                        <select id="startTime" class="form-select">
                            <option th:each="time : ${timeSlots}" th:value="${time}" th:text="${time}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="endTime" class="form-label">종료 시간</label>
                        <select id="endTime" class="form-select">
                            <option th:each="time : ${timeSlots}" th:value="${time}" th:text="${time}"></option>
                        </select>
                    </div>
                    <div class="d-grid">
                        <button id="submit-reservation" class="btn btn-primary">예약 신청</button>
                    </div>
                </div>
            </div>

            <!-- 예약 현황 -->
            <div class="col-md-7">
                <h5>예약 현황</h5>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-bordered text-center">
                        <thead>
                            <tr>
                                <th>시간</th>
                                <th>상태</th>
                                <th>예약자</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="slot : ${reservationStatus}" th:classappend="${slot.status != null} ? (${slot.status.name() == 'APPROVED'} ? 'reserved' : 'requested') : ''">
                                <td th:text="${slot.time}"></td>
                                <td th:text="${slot.status != null ? slot.status.name() : '예약 가능'}"></td>
                                <td th:text="${slot.reservedBy}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="text-end mt-4">
            <a th:href="@{/reservation/read/{roomId}(roomId=${room.id})}" class="btn btn-secondary">상세</a>
        </div>
    </div>
</main>
<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
$(document).ready(function() {
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");
    $(document).ajaxSend((e, xhr, options) => xhr.setRequestHeader(header, token));

    $('#reservationDate').on('change', function() {
        const date = $(this).val();
        window.location.href = '/reservation/apply/' + [[${room.id}]] + '?date=' + date;
    });

    $('#submit-reservation').on('click', function() {
        const date = $('#reservationDate').val();
        const startTime = $('#startTime').val();
        const endTime = $('#endTime').val();

        const reservationData = {
            roomId: [[${room.id}]],
            startTime: date + 'T' + startTime,
            endTime: date + 'T' + endTime
        };

        $.ajax({
            url: '/reservation/create',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(reservationData),
            success: function(response) {
                alert(response.message);
                window.location.reload();
            },
            error: function(xhr) {
                alert("예약 실패: " + xhr.responseJSON.message);
            }
        });
    });
});
</script>
</body>
</html>
